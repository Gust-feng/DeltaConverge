# 项目文件树与功能说明

```
Agent代码审查/
├── Agent/
│   ├── agents/                # 代码审查 Agent 及调度器（如 CodeReviewAgent）
│   │   └── review/            # 代码审查核心逻辑
│   │       └── code_reviewer.py
│   ├── core/                  # 框架核心（适配器、上下文、LLM 客户端、流式处理等）
│   │   ├── adapter/           # LLM/工具适配层（如 llm_adapter.py）
│   │   ├── llm/               # LLM 客户端（如 client.py，支持 Moonshot/Kimi）
│   │   ├── context/           # 上下文管理
│   │   ├── state/             # Agent 状态管理
│   │   ├── stream/            # 流式处理工具
│   │   └── tools/             # 工具运行时
│   ├── domain/                # 领域模型（可扩展）
│   ├── examples/              # 示例脚本（如 gui.py、run_agent.py）
│   ├── LLM/
│   │   └── moonshot/          # Moonshot/Kimi API 手册与端点参考
│   │       ├── api手册.md     # 主 API 手册（已拆分）
│   │       ├── README.md      # 手册索引
│   │       ├── tool_calls.md  # 工具调用说明
│   │       ├── files.md       # 文件接口说明
│   │       ├── formulas.md    # Formula/Fiber 说明
│   │       ├── api端点参考.md # 端点速查表
│   │       └── kimi.py        # Moonshot/Kimi 示例脚本
│   ├── tool/                  # 通用工具（如 funtion.py）
│   └── __init__.py            # 包初始化
├── DIFF/
│   ├── diff_collector.py      # Diff 感知层，负责收集变更、构建审查单元
│   └── rule/
│       └── context_decision.py# 规则层，推断上下文级别与 Agent 调度
├── Diff log/                  # 变更日志与 LLM 审查输出（review_for_llm_*.json）
├── venv/                      # Python 虚拟环境
├── .env                       # 环境变量（API 密钥等）
├── .gitignore                 # Git 忽略配置
├── 实时跟随.md                # 进度与架构跟踪文档
├── 文件.md                    # 其他文档
```

## 主要模块功能
- Agent/agents/review/code_reviewer.py：代码审查 Agent，负责调度 LLM/规则并生成审查建议。
- Agent/core/adapter/llm_adapter.py：LLM 适配层，统一不同模型的调用接口。
- Agent/core/llm/client.py：LLM 客户端，支持 Moonshot/Kimi，自动加载 .env 密钥。
- Agent/examples/gui.py：Tkinter GUI 示例，便于手动测试 Agent。
- Agent/LLM/moonshot/：API 手册与端点参考，支持 Moonshot/Kimi 对接。
- DIFF/diff_collector.py：感知层，收集 git diff、解析 PatchSet、构建审查单元。
- DIFF/rule/context_decision.py：规则层，推断上下文级别、是否需要 LLM Agent。
- Diff log/：保存每次审查的 LLM 友好输出与原始 diff。
- venv/、.env：虚拟环境与密钥配置。

> 详细功能与变更见下方进度记录。

## 2025-11-16
- 实现 `diff_collector.py`，覆盖 git 辅助函数、diff 获取、PatchSet 解析、ReviewUnit 构建以及 CLI 入口，满足 AI 代码审查感知层需求。
- 复查 `diff_collector.py` 的优化版，指出 AST 重复解析、合并上下文丢信息、摘要统计不准确等可改进点。
- 针对核心问题优化 `diff_collector.py`：缓存 Python AST、合并 hunk 时基于原文件重建上下文、修正摘要统计口径。
- 优化 LLM 视角：AST 结构检测改为选择“最内层”节点；在 LLM 输出中为每个变更补充 hunk_range、metrics、tags 以及 before/after 片段，按文件路径排序，方便模型直接理解多文件多代码段 diff。
- 新增 `context_decision.py` 规则层模块：基于 ReviewUnit 的 metrics/tags 等信息推断上下文级别（local/function/file）、是否需要调用上下文 Agent，并产出结构化的 AgentDecision 供调度器使用。
- 搭建跨模型可扩展的 LLM Agent 框架：实现 LLM Adapter、流式处理、工具运行时、对话状态、上下文提供器与代码审查 Agent，配合示例脚本，可并行执行 tool_calls 并遵循 Moonshot/Kimi 规则。
- 调整 Agent 框架目录，将 `core/`、`agents/`、`examples/` 等模块整合进 `Agent/` 包，并增加 `__init__.py` 以形成主要框架层级。
- 接入 Moonshot 正式 API：新增 `MoonshotLLMClient`，从 `.env` 读取密钥/模型，使用 HTTP 流式解析；示例脚本自动检测密钥并回落到 Mock。
- 临时增加 `Agent/examples/gui.py`，提供 Tkinter GUI 便于快速手动触发 Agent 测试（后续可删除）。
- 修复 GUI / 示例对 `.env` 的识别逻辑：使用 `dotenv` 加载，并尝试优先实例化 `MoonshotLLMClient`，失败时自动回退 Mock，确保配置密钥后能真实调用 Kimi。
- 加固 Moonshot 解析链路：`StreamProcessor` 与 `KimiAdapter` 兼容字符串/字典格式的 tool_calls 分片，`MoonshotLLMClient`/GUI/CLI 将缺失依赖时优雅降级，避免 `'str' object has no attribute 'get'` 等运行时报错。
- 新增 `APILogger`，`MoonshotLLMClient` 自动把每次请求/响应写入 `log/api_log`；GUI 允许输入 diff 文件路径并传入 agent，CLI 示例加入参数化 prompt/files。
- 将规则层拆入 `rule/` 包，确保 diff 收集时能加载上下文决策；`diff_provider` 集成 `diff_collector` 供 CLI/GUI 自动注入 diff summary，GUI 增加异常提示。
- 扩展 diff summary：在上下文中增加每个变更的完整 unified diff，使 LLM/Agent 能看到带 +/- 的代码片段（满足 echo_tool 需求）。
- GUI 支持流式展示与后台执行：`StreamProcessor` 增加 observer，GUI 启动后台线程消费 chunk，实时滚动输出；CLI/GUI 也会自动注入 venv site-packages，避免依赖缺失。
- 新增 GLM 厂商适配：实现 `GLMLLMClient`（默认 GLM-4.6），CLI/GUI 自动检测 `GLM_API_KEY`、优先选择智谱接口并继续沿用统一日志/流式处理。
- GUI 支持模型选择：新增下拉菜单可选择 auto/GLM/Moonshot/Mock，后台线程会根据用户选择构建对应 LLM 客户端并保持流式输出。
- 微调私有格式以支持工具：`NormalizedMessage` 记录 `provider`/`tool_schemas`，Adapter/LLM 客户端均可接收 `tools` 列表；Agent 支持向 LLM 传入工具定义，为后续构建 Tool Runtime 链路做准备。
- GUI 动态加载工具：新增 echo_tool 复选框，选择后会把对应 schema 透传给 LLM，请求中即可声明可用工具并保持 runtime 注册一致。
- 工具统一管理：新增 `Agent/tool/registry.py`，负责注册工具函数与 schema；CLI/GUI 都通过该 registry 动态获取工具列表和 schema，不再硬编码 `echo_tool`。
- 新增 `list_project_files` 工具：自动读取 Git 中未被 .gitignore 排除的文件夹及其文件，作为 LLM 可以调用的函数之一。
- 调整 GUI 布局：将模型选择与 “Run Agent” 按钮放在顶部横向布局，Prompt/Tools/Result 均在首屏可见，无需滚动即可输入与发送。
- 新增智谱 GLM 厂商接入：根据《智谱 GLM 模型 API 手册：工具调用与 Agent 构建指南》添加 GLM4.6 适配入口，密钥沿用环境变量管理。
- 不考虑使用API方式上传文件，依然使用本地策略调度上下文实现代码审查功能。
