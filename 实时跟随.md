# 项目文件树与功能说明

```
Agent代码审查/
├── Agent/
│   ├── agents/                    # 代码审查 Agent 及调度器（如 CodeReviewAgent）
│   │   └── review/                # 代码审查核心逻辑
│   │       └── code_reviewer.py
│   ├── core/                      # 框架核心（适配器、上下文、LLM 客户端、流式处理等）
│   │   ├── adapter/               # LLM/工具适配层（如 llm_adapter.py）
│   │   ├── context/               # 上下文管理（diff_provider 等）
│   │   ├── llm/                   # LLM 客户端（如 client.py，支持 Moonshot/Kimi/GLM）
│   │   ├── logging/               # API 调用与会话日志
│   │   ├── state/                 # Agent 状态管理（ConversationState）
│   │   ├── stream/                # 流式处理工具（StreamProcessor）
│   │   └── tools/                 # 工具运行时（ToolRuntime）
│   ├── ui/                        # UI 服务层，对 GUI/Web/CLI 暴露统一接口
│   │   ├── service.py             # create_llm_client / run_review / UsageAggregator
│   │   └── __init__.py
│   ├── web/                       # Web 包装层（FastAPI + 静态页面）
│   │   ├── server.py              # /api/review/start SSE 接口
│   │   └── static/                # Web 前端资源（index.html / main.js / style.css）
│   ├── examples/                  # 示例脚本（gui.py、run_agent.py 等）
│   ├── LLM/
│   │   └── moonshot/              # Moonshot/Kimi API 手册与端点参考
│   │       ├── api手册.md         # 主 API 手册（已拆分）
│   │       ├── README.md          # 手册索引
│   │       ├── tool_calls.md      # 工具调用说明
│   │       ├── files.md           # 文件接口说明
│   │       ├── formulas.md        # Formula/Fiber 说明
│   │       ├── api端点参考.md     # 端点速查表
│   │       └── kimi.py            # Moonshot/Kimi 示例脚本
│   ├── tool/                      # 通用工具注册与实现（registry.py）
│   ├── domain/                    # 领域模型（可扩展）
│   └── __init__.py                # 包初始化
├── DIFF/
│   ├── diff_collector.py          # Diff 感知层，负责收集变更、构建审查单元
│   └── rule/
│       └── context_decision.py    # 规则层，推断上下文级别与 Agent 调度
├── etc/                           # 设计文档与上下文规划
├── log/                           # 运行时日志（如 api_log/*.log）
├── requirements.txt               # Python 依赖
├── venv/                          # Python 虚拟环境（本地开发）
├── 实时跟随.md                    # 进度与架构跟踪文档
├── 一些问题.md                    # 设计/问题记录
├── 总规划.md                      # 项目整体规划
└── 文件.md                        # 其他文档索引
```

## 主要模块功能
- `Agent/agent/agents/code_reviewer.py`：代码审查 Agent，负责调度 LLM/工具并生成审查建议。
- `Agent/core/adapter/llm_adapter.py`：LLM 适配层，统一不同模型与工具调用接口。
- `Agent/core/llm/client.py`：LLM 客户端，支持 Moonshot/Kimi 与智谱 GLM，自动加载 .env 密钥。
- `Agent/core/context/diff_provider.py`：Diff 上下文提供器，负责收集 git diff 并构建“Markdown + 精简 JSON”上下文。
- `Agent/ui/service.py`：UI 服务层，为 CLI/GUI/Web 提供统一的 `create_llm_client` / `run_review` / `UsageAggregator` 接口。
- `Agent/web/server.py`：基于 FastAPI 的极简 Web 包装层，提供 `/api/review/start` SSE 接口与静态前端页面。
- `Agent/examples/gui.py`：Tkinter GUI 示例，可选择模型/项目根目录/工具，手动测试审查流程。
- `Agent/examples/run_agent.py`：CLI 示例入口，从命令行触发一次代码审查。
- `Agent/tool/registry.py`：工具注册中心，内置 `read_file_hunk` / `list_project_files` / `search_in_project` / `get_dependencies` 等工具。
- `Agent/LLM/moonshot/`：API 手册与端点参考，支持 Moonshot/Kimi 对接与工具调用示例。
- `DIFF/diff_collector.py`：感知层，收集 git diff、解析 PatchSet、构建审查单元并生成 LLM 友好 JSON。
- `DIFF/rule/context_decision.py`：规则层，推断上下文级别与变更风险标签，为后续调度策略提供结构化决策。
- `log/`：运行时会话日志（如 `agent_session_*.log`、`*_stream_chat_*.log`），用于追踪 token 用量与工具调用。
- `venv/`、`.env`：虚拟环境与本地密钥配置（未纳入版本控制）。

> 详细功能与变更见下方进度记录。

## 2025-11-16

- 实现 `diff_collector.py`，覆盖 git 辅助函数、diff 获取、PatchSet 解析、ReviewUnit 构建以及 CLI 入口，满足 AI 代码审查感知层需求。
- 复查 `diff_collector.py` 的优化版，指出 AST 重复解析、合并上下文丢信息、摘要统计不准确等可改进点。
- 针对核心问题优化 `diff_collector.py`：缓存 Python AST、合并 hunk 时基于原文件重建上下文、修正摘要统计口径。
- 优化 LLM 视角：AST 结构检测改为选择“最内层”节点；在 LLM 输出中为每个变更补充 hunk_range、metrics、tags 以及 before/after 片段，按文件路径排序，方便模型直接理解多文件多代码段 diff。
- 新增 `context_decision.py` 规则层模块：基于 ReviewUnit 的 metrics/tags 等信息推断上下文级别（local/function/file）、是否需要调用上下文 Agent，并产出结构化的 AgentDecision 供调度器使用。
- 搭建跨模型可扩展的 LLM Agent 框架：实现 LLM Adapter、流式处理、工具运行时、对话状态、上下文提供器与代码审查 Agent，配合示例脚本，可并行执行 tool_calls 并遵循 Moonshot/Kimi 规则。
- 调整 Agent 框架目录，将 `core/`、`agents/`、`examples/` 等模块整合进 `Agent/` 包，并增加 `__init__.py` 以形成主要框架层级。
- 接入 Moonshot 正式 API：新增 `MoonshotLLMClient`，从 `.env` 读取密钥/模型，使用 HTTP 流式解析；示例脚本自动检测密钥并回落到 Mock。
- 临时增加 `Agent/examples/gui.py`，提供 Tkinter GUI 便于快速手动触发 Agent 测试（后续可删除）。
- 修复 GUI / 示例对 `.env` 的识别逻辑：使用 `dotenv` 加载，并尝试优先实例化 `MoonshotLLMClient`，失败时自动回退 Mock，确保配置密钥后能真实调用 Kimi。
- 加固 Moonshot 解析链路：`StreamProcessor` 与 `KimiAdapter` 兼容字符串/字典格式的 tool_calls 分片，`MoonshotLLMClient`/GUI/CLI 将缺失依赖时优雅降级，避免 `'str' object has no attribute 'get'` 等运行时报错。
- 新增 `APILogger`，`MoonshotLLMClient` 自动把每次请求/响应写入 `log/api_log`；GUI 允许输入 diff 文件路径并传入 agent，CLI 示例加入参数化 prompt/files。
- 将规则层拆入 `rule/` 包，确保 diff 收集时能加载上下文决策；`diff_provider` 集成 `diff_collector` 供 CLI/GUI 自动注入 diff summary，GUI 增加异常提示。
- 扩展 diff summary：在上下文中增加每个变更的完整 unified diff，使 LLM/Agent 能看到带 +/- 的代码片段（满足 echo_tool 需求）。
- GUI 支持流式展示与后台执行：`StreamProcessor` 增加 observer，GUI 启动后台线程消费 chunk，实时滚动输出；CLI/GUI 也会自动注入 venv site-packages，避免依赖缺失。
- 新增 GLM 厂商适配：实现 `GLMLLMClient`（默认 GLM-4.6），CLI/GUI 自动检测 `GLM_API_KEY`、优先选择智谱接口并继续沿用统一日志/流式处理。
- GUI 支持模型选择：新增下拉菜单可选择 auto/GLM/Moonshot/Mock，后台线程会根据用户选择构建对应 LLM 客户端并保持流式输出。
- 微调私有格式以支持工具：`NormalizedMessage` 记录 `provider`/`tool_schemas`，Adapter/LLM 客户端均可接收 `tools` 列表；Agent 支持向 LLM 传入工具定义，为后续构建 Tool Runtime 链路做准备。
- GUI 动态加载工具：新增 echo_tool 复选框，选择后会把对应 schema 透传给 LLM，请求中即可声明可用工具并保持 runtime 注册一致。
- 工具统一管理：新增 `Agent/tool/registry.py`，负责注册工具函数与 schema；CLI/GUI 都通过该 registry 动态获取工具列表和 schema，不再硬编码 `echo_tool`。
- 新增 `list_project_files` 工具：自动读取 Git 中未被 .gitignore 排除的文件夹及其文件，作为 LLM 可以调用的函数之一。
- 调整 GUI 布局：将模型选择与 “Run Agent” 按钮放在顶部横向布局，Prompt/Tools/Result 均在首屏可见，无需滚动即可输入与发送。
- 完成首批通用工具注册：在统一 registry 中新增 `read_file_hunk`、增强版 `list_project_files`（支持 mode / dirs）、`read_file_info`、`search_in_project`（git grep）、`get_dependencies`（扫描依赖文件），供 LLM 按需调用。
- 新增工具审批逻辑：`CodeReviewAgent` 支持白名单与用户批准；CLI 通过交互式输入确认工具调用，GUI 则弹出对话框确认，只有获批的工具才会执行并继续下一轮 LLM 调用。
- 新增智谱 GLM 厂商接入：根据《智谱 GLM 模型 API 手册：工具调用与 Agent 构建指南》添加 GLM4.6 适配入口，密钥沿用环境变量管理。
- 不考虑使用API方式上传文件，依然使用本地策略调度上下文实现代码审查功能。


## 2025-11-20

- Diff 感知层：在 `DIFF/diff_collector.py` 抽出 `build_llm_friendly_output`，统一生成供 LLM 使用的结构化 diff JSON（review_metadata/summary/files[].changes[]），并在 change 级别补充 `metrics` 字段（added_lines/removed_lines），为后续“按风险/规模打分”做准备。
- 上下文构建：在 `Agent/core/context/diff_provider.py` 新增 `build_markdown_and_json_context`，基于 ReviewUnit/JSON 生成“Markdown + 精简 JSON”的混合上下文：Markdown 负责整体概览和重点变更列表，精简 JSON 作为结构化视图内嵌在 ```json 代码块中。
- 上下文筛选与降噪：在 `build_markdown_and_json_context` 中对每个变更打分并排序：按变更行数、标签（security_sensitive/config_file/routing_file/complete_* 等）加权，高风险/高影响变更优先展示；对 only_imports/only_comments/only_logging 这类噪音级改动降权，只在必要时简要带过，并统计被截断的次要变更数量写入说明。
- Agent 提示词：在 `Agent/agent/agents/code_reviewer.py` 更新系统提示，明确为“PR 代码审查员”角色，强调先整体理解，再聚焦高风险变更；要求必要时调用工具补充上下文，但避免无意义调用；遇到上下文不足时应说明“不能判断”而非瞎猜。
- 默认用户 Prompt：在 `Agent/examples/run_agent.py` 和 `Agent/examples/gui.py` 中更新默认 prompt，引导模型先阅读自动生成的“代码审查上下文”（Markdown+JSON），再围绕逻辑正确性、安全、配置/依赖影响、一致性和性能给出审查意见，并提示可以通过工具获取完整函数、调用链或依赖信息。
- 文档规划：在 `etc/上下文的权衡/2_上下文传递.md` 记录新的上下文传递设计，从“线性叠加消息”升级为分层上下文（静态 diff 上下文 + 短期对话窗口 + 工具记忆），并给出渐进落地方案，当前代码已完成首批“筛选重点 diff + 降噪 + 提示词对齐”的实现。
- 文档型 diff 轻量化：明确 DOC 扩展名（.md/.rst/.txt），将 `_truncate_doc_block` 提升为模块级工具，在 doc_light 模式下截断 unified_diff/before/after/context，并打上 `doc_file`/`context_mode=doc_light`，输出中用 `(doc snippet)` 代替全文。
- 提示与工具批量：系统/CLI/GUI 提示统一强调四类缺陷，并要求“一轮列出全部 tool_calls，等结果再推理”；Agent 不再附加 ContextProvider 全文片段，鼓励通过工具按需拉取上下文。
- 流式与日志：CodeReviewAgent 给流式回调追加 call_index，日志按 LLM_CALL_n/TOOLS_EXECUTION_n 记录；工具执行并发，等待结果后再下一轮 LLM。
- GUI Token 展示：按 call_index 统计单次用量并汇总 session_total，去除流式重复上报导致的虚高；提示格式与 CLI 统一为编号样式。
- 会话日志：agent_session 日志清晰记录每次请求/响应与工具结果，便于追踪 token 增长与上下文传递。

## 2025-11-21

- 抽象 UI 服务层：新增 `Agent/ui/service.py`，提供 `create_llm_client` / `run_review` / `UsageAggregator`，UI 可根据该内核自由实现（Tk/Web 等）。
- 精简 GUI：删除本地 Agent/LLM 组装与冗余统计，直接调用服务层；token 显示依赖 UsageAggregator；事件类型（delta/usage_summary）保持透传。
- Agent：提取 `_extract_usage`，统一从 normalized/raw chunks 回溯 usage，减少内联重复。
- LLM 客户端：流式解析时兼容 `choices[0].usage`，防止 usage 丢失；确保 GUI 能显示 tokens。
- 提高对非utf-8内容的兼容性，避免审查时遇到非文本内容导致崩溃
- 优化`api_log`日志解析并总结输出摘要信息，可读性更高

## 2025-11-24

- Diff 索引化：`DIFF/diff_collector.py` 增加 `_apply_rules_to_units`，在构建 ReviewUnit 时自动附加 `rule_suggestion`/`agent_decision`，并新增 `build_review_index` 输出轻量审查索引（仅元数据，不含 diff/上下文）。
- 上下文轻量化：`Agent/core/context/diff_provider.py` 在 `DiffContext` 内返回 review_index，默认摘要改为统计视图；`build_markdown_and_json_context` 仅基于索引生成轻量 Markdown+JSON，提醒通过工具获取代码片段。
- 首轮提示收缩：CLI/GUI（`Agent/examples/run_agent.py`、`Agent/examples/gui.py`、`Agent/ui/service.py`）改用索引上下文，不再把完整 Markdown+JSON diff 塞进首轮 prompt，默认提示同步强调“索引仅含元数据，需要代码请调用工具”。
- Agent 目录调整：`CodeReviewAgent` 迁至 `Agent/agent/agents/code_reviewer.py`，提示词集中到 `prompts.py`，旧路径保留 shim；新增占位的 `PlanningAgent`（未接入）。
- 规则与元数据强化：规则层扩展 `hunk_count` 参与置信度判断，细化文档/噪音/配置/安全等场景的 `rule_context_level` 与 `rule_confidence`；ReviewUnit/索引补充 `unit_id`/`patch_type`/`rule_*` 默认值。
- LLM JSON 能力统一：Moonshot/Kimi、GLM、Bailian 客户端支持透传 `response_format={"type": "json_object"}`（流式/非流式），为后续规划/多 Agent 的结构化输出打底。

## 2025-11-25
- 增强日志可追溯性：新增 `Agent/core/logging/context.py` 提供 trace_id，贯穿 PipelineLogger、APILogger、CodeReviewAgent、UI/CLI；每次会话统一 trace_id，便于跨文件关联。
- 日志健壮性：APILogger 在 start/append 前自动 mkdir，记录 trace_id；新增人类日志字段释义（rule_context_level/confidence 等）。PipelineLogger 行统一写 trace_id。
- LLM 客户端与超时：Bailian/GLM/Moonshot 客户端支持注入带 trace_id 的 APILogger，HTTP 超时默认提升至 120s；规划/审查增加超时与错误日志（planner_error/LLM_CALL_timeout）。
- GUI 体验：流式事件展示工具结果/usage，避免只见最终文本；GUI 调用统一走 service 层，杜绝多次 asyncio.run 引发 event loop 关闭。
- 上下文链路：ContextScheduler 尊重 skip_review；规划与规则融合后按 final_context_level 拉取上下文；Markdown 索引增加字段速览说明。
- 问题留存：流式审查仍未记录 usage（需在 StreamProcessor 补取 stop chunk 的 usage 字段）；大规模 review_index 导致规划请求 prompt_tokens ~41K，必要时应截断或分批。

> 使用修改后的审查系统进行自我审查，居然打掉六十万token🫨
