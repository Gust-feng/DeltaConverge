# 扫描器

初步想法是为每个语言都安装扫描器，但是需要配置好对应环境，而本地并没有配置好这些环境，所以选用`semgrep`作为通用扫描器，不过这个扫描器的耗时相对久，并且和其他扫描器相比会不会功能重叠了？

在对扫描器进行进一步开发过程中发现一个严重的性能问题，因为扫描器的初始化导致在构建发送给决策agent的元数据之前需要半分钟的时间，显然这是非常糟糕的，对于用户而言，需要经历半分钟的空白等待时间，虽然可以将扫描器初始化进度实时渲染前端，但是我在想为了给决策agent提供更多的元数据，这种边际效用是否必要，尤其对于变更较小的pr是否显得复杂，这个有待商榷



## 工作原理
- 语言识别：当你选择项目后，后端会扫描项目文件扩展名来识别所用语言，返回 detected_languages （如 “Python”“JavaScript”）。实现见 Agent/core/api/project.py:66-82 与 Agent/core/api/project.py:83-91 （Git 项目用 git ls-files ），以及非 Git 项目的回退遍历 Agent/core/api/project.py:93-106 。

- 前端过滤：前端将这些语言名映射为内部标识（如 "Python"→"python" ），再调用 GET /api/scanners/status ，只展示与检测到语言匹配的扫描器。实现见 UI/static/main.js:863-885 （映射）与 UI/static/main.js:889-898 （拉取与过滤）。

- 扫描器注册：后端用注册表维护“某语言有哪些扫描器”。多语言的 semgrep 会在导入时为多种语言自动注册；语言特定扫描器（如 pylint 、 eslint ）由对应模块导入后注册。入口在 Agent/DIFF/rule/__init__.py:11-37 （按语言尝试导入）， semgrep 的自动注册在 Agent/DIFF/rule/scanner_semgrep.py:321-363 。

- 可用性与计数：状态接口会为每种语言返回“已注册扫描器总数”和“其中可用的数量”。可用性由是否能在 PATH 中找到命令决定。接口与计算见 UI/server.py:765-781 ，注册查询见 Agent/DIFF/rule/scanner_registry.py:311-322 ，可用性检查见 Agent/DIFF/rule/scanner_base.py:277-307 和元信息 Agent/DIFF/rule/scanner_base.py:510-523 。前端将各语言的可用数/总数渲染为进度条与分数，汇总计算在 UI/static/main.js:902-907 。
关键流程

- 选择项目 → 前端拉取 /api/project/info?project_root=... 获取 detected_languages （ UI/static/main.js:863-888 ）。

- 前端调用 /api/scanners/status 获取所有语言的扫描器状态 → 只保留与 detected_languages 匹配的语言展示（ UI/static/main.js:889-898 ）。

- 后端构建状态时：
  - 基于注册表取该语言的扫描器类列表（“总数”） Agent/DIFF/rule/scanner_registry.py:311-322 。
  - 对每个扫描器调用 is_available() 判断是否安装（“可用数”） Agent/DIFF/rule/scanner_base.py:277-307 。
  - 返回每个扫描器的 name/command/available/enabled/timeout 等（ Agent/DIFF/rule/scanner_base.py:510-523 ）。
  
- 前端摘要视图显示每种语言 available_count/total_count ，详情视图显示具体工具且区分“已禁用（配置）”与“未安装（系统）”（ UI/static/main.js:929-975 ，状态文案逻辑 UI/static/main.js:949-956 ）。
数字为何是 3/4、1/1

- “总数”来源于“已注册的扫描器类”，不是简单配置里有多少。 semgrep 会始终注册；语言特定扫描器是否注册，取决于对应模块是否成功导入。总数也是因此因环境差异而变化。

- “可用数”来源于命令是否可执行（ PATH 中存在）。比如 Python 默认配置包含 semgrep/pylint/flake8/mypy 四个条目（ Agent/DIFF/rule/rule_config.py:74-96 ），但若实际只注册并且可用 3 个，就显示 3/4 。JavaScript 若只注册到 semgrep ，则显示 1/1 （配置中还有 eslint ，见 Agent/DIFF/rule/rule_config.py:157-169 ，但若模块未注册或命令不可用，总数/可用数会不同）。
## 代码位置

- 项目语言检测： Agent/core/api/project.py:66-82 、 Agent/core/api/project.py:83-91 、 Agent/core/api/project.py:93-106

- 前端语言映射与过滤： UI/static/main.js:863-885 、 UI/static/main.js:889-898

- 状态接口： UI/server.py:765-781

- 扫描器注册与实例查询： Agent/DIFF/rule/__init__.py:11-37 、 Agent/DIFF/rule/scanner_semgrep.py:321-363 、 Agent/DIFF/rule/scanner_registry.py:311-322

- 可用性检查与元信息： Agent/DIFF/rule/scanner_base.py:277-307 、 Agent/DIFF/rule/scanner_base.py:510-523

  ## 补充说明

- 若希望“对应扫描器”显示更多工具：
  - 确保相应扫描器模块已注册（语言专用模块导入成功），并在配置中 enabled=true （示例见 Agent/DIFF/rule/rule_config.py ）。
  - 安装并确保命令在 PATH 中（例如 pylint 、 flake8 、 eslint 、 checkstyle 等），否则 is_available() 会把它计为不可用。