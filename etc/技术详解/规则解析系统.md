# 规则解析系统

## 概述

规则解析系统是代码审查内核的核心组件之一，负责为每个变更单元（ReviewUnit）计算上下文建议和置信度。它采用**规则+LLM融合**的策略，通过静态规则快速筛选，为后续的LLM决策提供参考基准。

### 设计理念

```
传统方案：LLM直接处理所有变更 → 上下文不足或信息噪音
本系统：规则层预处理 + LLM决策 → 精准上下文调度
```

规则层的核心价值：
- **快速筛选**：毫秒级完成变更分类，无需LLM调用
- **置信度基准**：为融合决策提供可量化的参考
- **可解释性**：规则匹配结果可追溯，便于调试
- **多语言支持**：针对不同语言的特性定制规则

## 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        规则解析系统                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ RuleHandler │    │ RuleConfig  │    │rule_registry│         │
│  │   (基类)     │    │  (配置)     │    │ (函数注册表) │         │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
│         │                  │                  │                 │
│         ▼                  ▼                  ▼                 │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              语言特定处理器                           │       │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │       │
│  │  │ Python  │ │  Java   │ │   Go    │ │TypeScript│   │       │
│  │  │ Handler │ │ Handler │ │ Handler │ │ Handler  │   │       │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │       │
│  └─────────────────────────────────────────────────────┘       │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────┐       │
│  │              代码扫描器集成                           │       │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │       │
│  │  │ Pylint  │ │Checkstyle│ │golangci │ │ ESLint  │   │       │
│  │  │ Scanner │ │ Scanner │ │ Scanner │ │ Scanner │   │       │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │       │
│  └─────────────────────────────────────────────────────┘       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  RuleSuggestion │
                    │  (输出结构)      │
                    └─────────────────┘
```

## 核心组件

### RuleHandler 基类

所有语言处理器的基类，定义了规则匹配的标准接口：

```python
class RuleHandler:
    """规则处理器基类"""
    
    def __init__(self, language: str = None):
        self.language = language
        self.config = get_rule_config()
        self._scanners: List[BaseScanner] = []
    
    def match(self, unit: Dict[str, Any]) -> Optional[RuleSuggestion]:
        """匹配规则，返回建议"""
        pass
```

### RuleSuggestion 输出结构

规则匹配的输出结构，包含上下文级别、置信度和附加信息：

```python
@dataclass
class RuleSuggestion:
    context_level: str      # local | function | file（后续会映射到 diff_only | function | file_context）
    confidence: float       # 0.0 - 1.0
    notes: str              # 匹配说明
    extra_requests: List[Dict[str, Any]]  # 额外请求（如 previous_version/search_callers/search_config_usage/scanner_issues 等）
```

### 上下文级别说明

| 级别 | 说明 | 适用场景 |
|------|------|----------|
| `local` | 仅diff内容 | 简单变更、注释修改、日志调整 |
| `function` | diff + 所在函数 | 函数内部逻辑修改 |
| `file` | diff + 整个文件 | 类定义、配置文件、大范围重构 |

注：规则层输出使用 `local/function/file`；在 ReviewUnit/review_index 中会被规范化为统一语义 `diff_only/function/file_context`。

## 置信度计算

> **核心公式**
> ```
> 最终置信度 = 匹配确定性 × 0.6 + 风险加成 + 0.15
> ```
> 其中：
> - **匹配确定性** = 0.3 + 特异性得分 + 精度得分 + 上下文得分 + 语言加成
> - **风险加成** = {critical: 0.30, high: 0.20, medium: 0.10, low: 0.0}

### 计算流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     置信度计算流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────┐     ┌─────────────────────┐           │
│  │   _ConfidenceFactors │     │    _RiskFactors     │           │
│  │   ├─ rule_specificity│     │   ├─ change_scope   │           │
│  │   ├─ pattern_precision│    │   ├─ security_sensitive│        │
│  │   ├─ context_availability│ │   ├─ change_type    │           │
│  │   └─ language_bonus  │     │   ├─ pattern_risk   │           │
│  └──────────┬──────────┘     │   └─ symbol_risk    │           │
│             │                 └──────────┬──────────┘           │
│             ▼                            ▼                       │
│  ┌─────────────────────┐     ┌─────────────────────┐           │
│  │  to_match_certainty()│     │   to_risk_level()   │           │
│  │  计算匹配确定性      │     │   计算风险等级       │           │
│  │  范围: 0.3 ~ 1.0     │     │   critical/high/    │           │
│  └──────────┬──────────┘     │   medium/low        │           │
│             │                 └──────────┬──────────┘           │
│             │                            │                       │
│             └────────────┬───────────────┘                       │
│                          ▼                                       │
│             ┌─────────────────────────┐                         │
│             │ _compute_final_confidence│                         │
│             │ 最终置信度 = MC×0.6 +    │                         │
│             │            风险加成 + 0.15│                         │
│             │ 范围: 0.0 ~ 1.0          │                         │
│             └─────────────────────────┘                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 第一步：计算匹配确定性（Match Certainty）

匹配确定性表示规则对变更单元匹配的确定程度，由四个因子构成：

| 因子 | 范围 | 权重 | 说明 |
|------|------|------|------|
| `rule_specificity` | 0-5 | ×0.06（最大0.3） | 匹配条件数量越多越精确 |
| `pattern_precision` | 0.0-1.0 | ×0.3 | 精确匹配=1.0, 部分匹配=0.5 |
| `context_availability` | 0.0-1.0 | ×0.2 | 符号信息完整度 |
| `language_bonus` | 0.0-0.1 | ×1.0 | 语言特定规则加成 |

**计算公式**：
```
匹配确定性 = 0.3（基础值）
           + min(rule_specificity × 0.06, 0.3)
           + pattern_precision × 0.3
           + context_availability × 0.2
           + language_bonus
```

```python
@dataclass
class _ConfidenceFactors:
    rule_specificity: int = 0      # 规则特异性（0-5）
    pattern_precision: float = 0.0  # 模式精度（0.0-1.0）
    context_availability: float = 0.0  # 上下文可用性（0.0-1.0）
    language_bonus: float = 0.0     # 语言特定加成（0.0-0.1）
    
    def to_match_certainty(self) -> float:
        base = 0.3  # 基础置信度
        specificity_score = min(self.rule_specificity * 0.06, 0.3)
        precision_score = self.pattern_precision * 0.3
        context_score = self.context_availability * 0.2
        lang_score = self.language_bonus
        
        return min(1.0, base + specificity_score + precision_score + context_score + lang_score)
```

### 第二步：计算风险等级（Risk Level）

风险等级表示变更需要审查的重要程度：

```python
@dataclass
class _RiskFactors:
    change_scope: int = 0           # 变更行数
    security_sensitive: bool = False # 安全敏感
    change_type: str = "modify"     # add/modify/delete
    pattern_risk: str = "medium"    # low/medium/high
    symbol_risk: str = "low"        # low/medium/high
```

**风险等级判定逻辑**：
1. 安全敏感（`security_sensitive=True`）→ 直接返回 `critical`（大范围）或 `high`
2. 否则，基于各因子计算风险分数：
   - 变更范围：>100行=+3, >50行=+2, >20行=+1
   - 变更类型：delete=+2, modify=+1
   - 模式风险：high=+2, medium=+1, low=0
   - 符号风险：high=+2, medium=+1, low=0
3. 分数映射：≥6=critical, ≥4=high, ≥2=medium, <2=low

### 第三步：计算最终置信度

```python
def _compute_final_confidence(match_certainty: float, risk_level: str) -> float:
    risk_weight = {"critical": 0.30, "high": 0.20, "medium": 0.10, "low": 0.0}
    risk_bonus = risk_weight.get(risk_level, 0.10)
    
    # 最终置信度 = 匹配确定性 × 0.6 + 风险加成 + 基础偏移
    final = match_certainty * 0.6 + risk_bonus + 0.15
    
    return round(max(0.0, min(1.0, final)), 2)
```

### 计算示例

**示例1：高风险安全敏感变更**
```
输入：
  - rule_specificity = 3 (匹配了3个条件)
  - pattern_precision = 1.0 (精确匹配)
  - context_availability = 0.8 (符号信息完整)
  - language_bonus = 0.05 (Python特定规则)
  - security_sensitive = True, change_scope = 60

计算过程：
  匹配确定性 = 0.3 + min(3×0.06, 0.3) + 1.0×0.3 + 0.8×0.2 + 0.05
             = 0.3 + 0.18 + 0.3 + 0.16 + 0.05
             = 0.99
  
  风险等级 = critical (security_sensitive + 大范围)
  风险加成 = 0.30
  
  最终置信度 = 0.99 × 0.6 + 0.30 + 0.15
             = 0.594 + 0.30 + 0.15
             = 1.0 (上限截断)
```

**示例2：普通小范围变更**
```
输入：
  - rule_specificity = 1
  - pattern_precision = 0.5
  - context_availability = 0.3
  - language_bonus = 0.0
  - change_scope = 10, change_type = "modify"

计算过程：
  匹配确定性 = 0.3 + 0.06 + 0.15 + 0.06 + 0.0 = 0.57
  风险等级 = low (分数 = 0+1+1+0 = 2 → medium... 实际是 1+1=2 → medium)
  风险加成 = 0.10
  
  最终置信度 = 0.57 × 0.6 + 0.10 + 0.15
             = 0.342 + 0.10 + 0.15
             = 0.59
```

### 置信度阈值

系统定义了统一的置信度阈值：

| 阈值 | 值 | 含义 |
|------|-----|------|
| `CONFIDENCE_HIGH` | 0.8 | 规则建议为权威来源 |
| `CONFIDENCE_MEDIUM` | 0.5 | 中等置信度 |
| `CONFIDENCE_LOW` | 0.3 | 优先采用LLM建议 |
| `CONFIDENCE_DEFAULT` | 0.35 | 默认fallback置信度 |
| `CONFIDENCE_MIN` | 0.3 | 默认置信度范围下限 |
| `CONFIDENCE_MAX` | 0.45 | 默认置信度范围上限 |

### 置信度在融合中的作用

```python
# 融合决策逻辑（简化）
if rule_confidence >= 0.8:
    # 高置信度：规则建议为主
    final_level = rule_context_level
elif rule_confidence >= 0.5:
    # 中等置信度：综合考虑
    final_level = max(rule_context_level, llm_context_level)
else:
    # 低置信度：LLM建议为主
    final_level = llm_context_level
```



## 规则匹配流程

### 匹配优先级

每个语言处理器按以下优先级进行规则匹配：

```
1. 装饰器/注解模式 → 框架特定规则（如 @RestController, @pytest.fixture）
2. 框架路径规则   → 框架目录结构（如 controllers/, models/）
3. 配置路径规则   → 通用路径模式（如 config/, settings.py）
4. 符号规则       → 函数/类名称模式（如 test_, __init__）
5. 度量规则       → 变更行数阈值
6. 关键词规则     → 安全/配置关键词
7. 变更模式检测   → 通用变更模式（如 import_only, error_handling）
8. 默认回退       → 返回 function 级别，低置信度
```

### 变更模式定义

系统内置了多种变更模式识别：

```python
CHANGE_PATTERNS = {
    "import_only": {
        "description": "仅导入语句变更",
        "risk": "low",
        "context_level": "local",
        "indicators": ["import ", "from ", "require(", ...]
    },
    "signature_change": {
        "description": "函数签名变更",
        "risk": "high",
        "context_level": "file",
        "indicators": ["def ", "function ", "async ", ...],
        "extra_requests": [{"type": "search_callers"}]
    },
    "error_handling": {
        "description": "异常处理变更",
        "risk": "medium",
        "context_level": "function",
        "indicators": ["try:", "catch ", "except ", ...]
    },
    "security_sensitive": {
        "description": "安全敏感变更",
        "risk": "critical",
        "context_level": "file",
        "indicators": ["password", "secret", "token", "auth", ...]
    },
    # ... 更多模式
}
```

### 符号分析

系统会分析变更单元的符号信息，判断：

- **公共API**：不以 `_` 开头的函数/方法
- **构造函数**：`__init__`, `constructor`, `new` 等
- **接口/抽象类**：`IXxx`, `XxxInterface`, `AbstractXxx`
- **数据模型**：`XxxModel`, `XxxSchema`, `XxxEntity`
- **配置文件**：路径包含 `config/`, 扩展名为 `.yaml/.json/.toml`

符号分析结果用于：
1. 计算符号风险等级
2. 生成跨文件依赖提示（extra_requests）

```python
def get_dependency_hints(self) -> List[Dict[str, Any]]:
    hints = []
    if self.is_public_api:
        hints.append({"type": "search_callers"})
    if self.is_interface:
        hints.append({"type": "search_implementations"})
    if self.is_config_file:
        hints.append({"type": "search_config_usage"})
    if self.is_data_model:
        hints.append({"type": "search_model_usage"})
    return hints
```

说明：上述 `search_*` 为规则侧“跨文件依赖提示”，会进入 `rule_extra_requests` 作为规划参考；主链路是否执行取决于 PlanningAgent/ContextScheduler 的支持。

## 多语言支持

### 支持的语言

| 语言 | 处理器 | 特性 |
|------|--------|------|
| Python | `PythonRuleHandler` | 装饰器识别、Django/Flask/FastAPI框架规则 |
| Java | `JavaRuleHandler` | 注解识别、Spring/JPA框架规则 |
| Go | `GoRuleHandler` | 包结构规则、Gin/Echo框架规则 |
| TypeScript | `TypeScriptRuleHandler` | 装饰器识别、Next.js/NestJS框架规则 |
| Ruby | `RubyRuleHandler` | Rails框架规则、Gem依赖规则 |

### Python 规则示例

```python
# 装饰器模式识别
PYTHON_DECORATOR_PATTERNS = {
    "django_view": {
        "patterns": [r"@login_required", r"@permission_required", ...],
        "risk": "high",
        "context_level": "function",
        "framework": "django"
    },
    "fastapi_route": {
        "patterns": [r"@app\.get", r"@app\.post", r"@router\.get", ...],
        "risk": "high",
        "context_level": "function",
        "framework": "fastapi"
    },
    "celery_task": {
        "patterns": [r"@app\.task", r"@shared_task", ...],
        "risk": "high",
        "context_level": "function",
        "framework": "celery"
    }
}

# 框架路径规则
PYTHON_FRAMEWORK_PATH_RULES = [
    {
        "match": ["models.py", "models/"],
        "context_level": "file",
        "base_confidence": 0.88,
        "notes": "py:django:models",
        "framework": "django"
    },
    {
        "match": ["routers/", "endpoints/", "api/"],
        "context_level": "function",
        "base_confidence": 0.88,
        "notes": "py:fastapi:routers",
        "framework": "fastapi"
    }
]
```

### Java 规则示例

```python
# 注解模式识别
JAVA_ANNOTATION_PATTERNS = {
    "spring_component": {
        "patterns": [r"@Component\b", r"@Service\b", r"@Repository\b", ...],
        "risk": "high",
        "context_level": "file",
        "framework": "spring"
    },
    "spring_security": {
        "patterns": [r"@PreAuthorize\b", r"@Secured\b", ...],
        "risk": "critical",
        "context_level": "function",
        "framework": "spring-security"
    },
    "jpa_entity": {
        "patterns": [r"@Entity\b", r"@Table\b", ...],
        "risk": "high",
        "context_level": "file",
        "framework": "jpa"
    }
}
```

### 添加新语言支持

1. 创建语言处理器文件：

```python
# Agent/DIFF/rule/rule_lang_xxx.py
from Agent.DIFF.rule.rule_base import RuleHandler, RuleSuggestion

class XxxRuleHandler(RuleHandler):
    def __init__(self):
        super().__init__(language="xxx")
    
    def match(self, unit: Dict[str, Any]) -> Optional[RuleSuggestion]:
        # 实现匹配逻辑
        pass
```

2. 在注册表中注册：

```python
# Agent/DIFF/rule/rule_registry.py
from Agent.DIFF.rule.rule_lang_xxx import XxxRuleHandler
register_rule_handler("xxx", XxxRuleHandler)
```

3. 添加配置规则：

```python
# Agent/DIFF/rule/rule_config.py
DEFAULT_RULE_CONFIG["languages"]["xxx"] = {
    "path_rules": [...],
    "symbol_rules": [...],
    "metric_rules": [...],
    "keywords": [...]
}
```

## 代码扫描器集成

### 扫描器架构

规则系统集成了外部代码扫描器（linter、type checker），提供更精确的问题检测：

```
┌─────────────────────────────────────────────────────────────────┐
│                      ScannerRegistry                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ get_scanners│  │set_config   │  │get_available│             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       BaseScanner                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │    scan     │  │parse_output │  │is_available │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  PylintScanner  │ │CheckstyleScanner│ │  ESLintScanner  │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

### ScannerIssue 结构

扫描器输出的问题结构：

```python
@dataclass
class ScannerIssue:
    line: int           # 行号（1-indexed）
    column: int         # 列号（1-indexed）
    severity: str       # error | warning | info
    message: str        # 问题描述
    rule_id: str        # 规则ID
```

### 严重性标准化

不同扫描器的严重性级别会被标准化：

```python
SEVERITY_MAPPINGS = {
    # Error level
    "error": "error", "fatal": "error", "critical": "error",
    # Warning level
    "warning": "warning", "warn": "warning", "caution": "warning",
    # Info level
    "info": "info", "note": "info", "hint": "info", "style": "info"
}
```

### 扫描器配置

```python
DEFAULT_SCANNER_CONFIG = {
    "python": {
        "pylint": {"enabled": True, "timeout": 30, "extra_args": []},
        "flake8": {"enabled": True, "timeout": 30, "extra_args": []},
        "mypy": {"enabled": False, "timeout": 60, "extra_args": ["--ignore-missing-imports"]}
    },
    "java": {
        "checkstyle": {"enabled": True, "timeout": 30, "extra_args": []},
        "pmd": {"enabled": True, "timeout": 30, "extra_args": []}
    },
    # ... 其他语言
}
```

### 扫描器与规则的融合

扫描器结果会影响规则建议：

```python
def _apply_scanner_results(
    self, 
    suggestion: RuleSuggestion, 
    scanner_issues: List[ScannerIssue]
) -> RuleSuggestion:
    """将扫描器结果应用到规则建议"""
    if not scanner_issues:
        return suggestion
    
    # 有错误级别问题时提升上下文级别
    has_errors = any(i.severity == "error" for i in scanner_issues)
    if has_errors and suggestion.context_level == "local":
        return RuleSuggestion(
            context_level="function",
            confidence=min(suggestion.confidence + 0.1, 1.0),
            notes=f"{suggestion.notes};scanner_errors",
            extra_requests=suggestion.extra_requests
        )
    
    return suggestion
```

## 配置系统

### 配置结构

```python
DEFAULT_RULE_CONFIG = {
    "base": {
        "large_change_lines": 80,
        "moderate_change_lines": 20,
        "noise_tags": ["only_imports", "only_comments", "only_logging"],
        "doc_tags": ["doc_file"],
        "security_keywords": ["auth", "token", "password", "secret", ...],
        "config_keywords": ["config", "setting", ".env", ...]
    },
    "scanners": {
        "python": {...},
        "java": {...},
        # ...
    },
    "languages": {
        "python": {
            "path_rules": [...],
            "symbol_rules": [...],
            "metric_rules": [...],
            "keywords": [...]
        },
        # ... 其他语言
    }
}
```

### 外部配置文件

支持从外部JSON/YAML文件加载配置：

```python
# 加载外部配置
config = get_rule_config(config_path="custom_rules.yaml")

# 配置会与默认配置合并
merged_config = merge_configs(DEFAULT_RULE_CONFIG, external_config)
```

### 配置优先级

```
外部配置 > 语言特定配置 > 基础配置 > 硬编码默认值
```

## 相关文档

- [架构设计](../核心文档/架构设计.md)：系统整体架构
- [审查链路](审查链路.md)：完整的审查流程
- [上下文调度策略](上下文调度策略.md)：融合策略详解
- [自我学习机制](自我学习机制.md)：规则增长闭环
