# 链路与数据格式说明（规则→决策→融合→上下文）

## 1. 规则解析输出（挂载在 ReviewUnit / review_index）
字段（每个审查单元 unit）：
- `unit_id` / `id`：唯一标识。
- `file_path`：文件路径。
- `language`：语言。
- `patch_type`/`change_type`：新增/修改等。
- `tags`：规则/语义标签（含 security_sensitive/config_file/routing_file/only_* 等）。
- `metrics`：变更规模（added_lines/removed_lines/hunk_count）。
- `rule_context_level`：规则建议的上下文粒度（diff_only/function/file_context）。
- `rule_confidence`：规则置信度（0-1）。
- `rule_notes`：规则匹配说明/备注（供融合层识别风险与来源）。
- `rule_extra_requests`：规则侧建议的附加上下文（如 previous_version/search_callers/search_config_usage/scanner_issues 等），可为空。
- `line_numbers`：行号摘要（new_compact/old_compact）。
- `agent_decision`（精简版）：仅保留 `context_level`、`priority`，用于展示/排序。

已去除冗余：review_index 不下传 rule_suggestion 与 diff 正文；agent_decision 为精简版（仅 context_level/priority）。

## 2. 决策 Agent（Planner）输入/输出
- 输入：`planner_index`（瘦身索引）
```json
{
  "review_metadata": {"mode": "staged|working|pr", "base_branch": "...", "total_files": 3, "total_changes": 8, "timestamp": "..."},
  "summary": {"changes_by_type": {"add":0,"modify":3,"delete":0}, "total_lines": {"added": 120, "removed": 30}, "files_changed": ["src/a.py", "..."]},
  "units": [
    {
      "unit_id": "...",
      "file_path": "src/a.py",
      "patch_type": "modify",
      "tags": ["security_sensitive"],
      "metrics": {"added_lines": 10, "removed_lines": 2, "hunk_count": 1},
      "rule_context_level": "function",
      "rule_confidence": 0.9,
      "line_numbers": {"new_compact": "L20-L35", "old_compact": "L10-L22"},
      "rule_extra_requests": [{"type": "previous_version"}]
    }
  ]
}
```
- 输出（llm_plan）：
```json
{
  "plan": [
    {
      "unit_id": "...",
      "llm_context_level": "function|file_context|full_file|diff_only",
      "extra_requests": [
        {"type": "previous_version", "details": null},
        {"type": "callers", "details": "my_function"},
        {"type": "search", "details": "my_function"}
      ],
      "skip_review": false,
      "reason": "..."
    }
  ]
}
```

说明：
- PlanningAgent 当前输出的 extra_requests 项格式为 `{"type": "...", "details": "..."}`。
- ContextScheduler 执行 `previous_version` 不需要额外字段；执行 `callers/search` 需要 `symbol` 或 `keyword|text`。
- 当前未做 `details -> symbol/keyword` 映射，且未实现 `search_callers/search_config_usage/search_implementations/search_model_usage/search_class_methods` 等类型的调度；因此现阶段仅 `previous_version` 能稳定生效。

## 3. 融合输出（fuse_plan）
输入：review_index.units + llm_plan.plan
输出：
```json
{
  "plan": [
    {
      "unit_id": "...",
      "rule_context_level": "function",
      "rule_confidence": 0.9,
      "llm_context_level": "file_context",
      "final_context_level": "file_context",   // 融合后的上下文粒度
      "extra_requests": [ ... ],                // LLM extra_requests 优先，否则回退 rule_extra_requests
      "skip_review": false,
      "reason": "rule_high_confidence_fallback|dropped_by_fusion_low_confidence|llm_reason..."
    }
  ]
}
```
规则：高/中风险单元兜底选中；上下文级别按 rule_confidence 与 llm 建议优先级融合。

## 4. 上下文拉取（build_context_bundle）
输入：fused_plan + DiffContext.units
逻辑：
- 遍历 fused plan 中未 skip 的 unit：
  - 根据 final_context_level 读取文件片段：diff_only / function / file_context / full_file（带截断）。
  - 处理 extra_requests：
    - `previous_version`：`git show base:file` 读取旧版本片段。
    - `callers`：读取 `symbol` 并搜索调用方（为空则跳过）。
    - `search`：读取 `keyword`（或 `text`）并搜索文本（为空则跳过）。
- 输出 bundle item 示例：
```json
{
  "unit_id": "...",
  "meta": {"file_path": "src/a.py", "tags": ["security_sensitive"], "hunk_range": {...}, "line_numbers": {...}, "location": "src/a.py:L20-L35"},
  "final_context_level": "file_context",
  "extra_requests": [{"type": "previous_version"}],
  "diff": "@@ src/a.py:L20-L35 @@...",            // 截断版 diff
  "function_context": "...",                      // 视级别而定，可能为空
  "file_context": "...",
  "full_file": null,
  "previous_version": "...",                     // 如有
  "callers": [ {"file_path": "...", "snippet": "..."} ]
}
```
- 该 bundle 用于最终审查提示，未包含全文，截断控制体积。

## 5. 审查 Agent（CodeReviewAgent）
- 输入：用户提示 + 审查索引 Markdown + 上下文 bundle（JSON 嵌入）。
- 如需更多代码，调用工具（read_file_hunk/search 等）。

## 6. 降噪措施
- Planner 使用瘦身 `planner_index`（无 diff/changes，无 rule_suggestion/notes）。
- review_index 精简：去掉 rule_suggestion 与 diff 正文；`agent_decision` 仅保留 context_level/priority；`units` 仍保留 rule_notes/rule_extra_requests 供融合与调度使用。
- 融合 extra_requests 回退规则侧，避免 LLM 缺省。
- 规则置信度提升安全/配置类，降低噪音标签置信度。

***本文档由AI自动生成，可能存在不准确的问题，不过仍然使用`GPT-5.2 X-High Reasoning`进行多次交叉验证***
