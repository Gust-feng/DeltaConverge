# 审查链路详解

## 链路总览

代码审查系统的完整链路从Git Diff输入开始，经过多个处理阶段，最终输出结构化的审查报告。整个流程采用流水线架构，每个阶段职责明确、数据流转清晰。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              审查链路总览                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  Git Diff
     │
     ▼
┌─────────────┐
│ 阶段1: Diff │ ──→ 解析diff，构建ReviewUnit列表
│   解析      │     输出: units[], files[]
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段2: 规则 │ ──→ 为每个unit计算置信度和建议
│   分析      │     输出: rule_context_level, rule_confidence
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段3: 意图 │ ──→ 理解项目整体意图
│   分析      │     输出: intent_summary_md
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段4: 上下 │ ──→ 规划每个unit的上下文级别
│   文规划    │     输出: plan JSON
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段5: 融合 │ ──→ 融合规则建议与LLM决策
│   决策      │     输出: fused_plan
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段6: 上下 │ ──→ 拉取实际代码上下文
│   文调度    │     输出: context_bundle[]
└─────────────┘
     │
     ▼
┌─────────────┐
│ 阶段7: 审查 │ ──→ 执行代码审查
│   执行      │     输出: 审查报告
└─────────────┘
```

## 阶段1：Diff解析与ReviewUnit构建

### 输入
- Git diff输出（支持工作区、暂存区、PR三种模式）

### 处理流程

```python
# Agent/DIFF/diff_collector.py
def collect_diff_context(mode: DiffMode, base_branch: str = None) -> DiffContext:
    """收集diff上下文，返回结构化的DiffContext对象。"""
```

1. **获取原始diff**：根据模式调用对应的git命令
   - `working`: `git diff HEAD`
   - `staged`: `git diff --cached`
   - `pr`: `git diff {base_branch}...HEAD`

2. **解析PatchSet**：使用unidiff库解析diff文本

3. **构建ReviewUnit**：为每个hunk创建审查单元
