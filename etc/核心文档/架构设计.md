# 架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           外部调用层                                      │
│              (GUI / CLI / Web Server / 第三方集成)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           API 门面层                                      │
│   AgentAPI │ ConfigAPI │ CacheAPI │ HealthAPI │ DiffAPI │ ToolAPI       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         审查内核 (ReviewKernel)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ IntentAgent │→ │PlanningAgent│→ │   Fusion    │→ │ContextSched │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│                                                            │            │
│                                                            ▼            │
│                                                   ┌─────────────┐       │
│                                                   │CodeReviewAgt│       │
│                                                   └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
          ┌─────────────────────────┼─────────────────────────┐
          ▼                         ▼                         ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    DIFF 层       │      │    规则层        │      │    工具层        │
│  diff_collector │      │  RuleHandler    │      │  ToolRuntime    │
│  review_units   │      │  RuleAnalyzer   │      │  tool_registry  │
│  git_operations │      │  ConflictTracker│      │  内置工具        │
└─────────────────┘      └─────────────────┘      └─────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           LLM 适配层                                      │
│   LLMAdapter │ StreamProcessor │ BaseLLMClient (GLM/Bailian/Moonshot)   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 内核设计理念

### ReviewKernel：编排引擎

`ReviewKernel` 是系统的核心，但它本身不包含业务逻辑，只负责**编排**各个Agent和模块的工作流程：

```python
class ReviewKernel:
    """核心审查引擎，负责编排各 Agent 与 Context 模块。"""
    
    async def run(self, prompt, tool_names, auto_approve, diff_ctx, ...):
        # 1. 意图分析阶段
        intent_summary = await intent_agent.run(intent_inputs)
        
        # 2. 规划阶段
        plan = await planner.run(planner_index, intent_md=intent_summary)
        
        # 3. 融合阶段
        fused = fuse_plan(review_index, plan)
        
        # 4. 上下文调度阶段
        context_bundle = build_context_bundle(diff_ctx, fused)
        
        # 5. 审查执行阶段
        result = await agent.run(augmented_prompt, tools, ...)
        
        return result
```

这种设计的好处：
- **关注点分离**：每个模块只做一件事
- **易于测试**：可以单独测试每个阶段
- **易于扩展**：新增阶段只需修改编排逻辑

### API作为控制面

所有外部交互通过 `Agent.core.api` 模块进行，内核不直接暴露给外部：

```python
from Agent.core.api import (
    AgentAPI,      # 核心审查
    ConfigAPI,     # 配置管理
    CacheAPI,      # 缓存管理
    HealthAPI,     # 健康检查
    DiffAPI,       # Diff分析
    ToolAPI,       # 工具管理
)
```

## 多Agent协作模式

### Agent职责划分

```
┌─────────────────────────────────────────────────────────────────┐
│                        IntentAgent                               │
│  输入: 文件树、README、提交历史                                    │
│  输出: 项目概览Markdown                                           │
│  职责: 理解项目整体意图，为后续规划提供背景                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       PlanningAgent                              │
│  输入: 规则索引(planner_index)、项目意图、用户指令                  │
│  输出: 上下文计划JSON                                             │
│  职责: 决定每个变更单元需要什么级别的上下文                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      CodeReviewAgent                             │
│  输入: 上下文包(ContextBundle)、工具链                            │
│  输出: 审查报告Markdown                                           │
│  职责: 执行实际的代码审查，可调用工具获取更多信息                     │
└─────────────────────────────────────────────────────────────────┘
```

### 数据流转

```
Git Diff
    │
    ▼
┌─────────────┐
│ DiffCollector│ ──→ 解析diff，生成ReviewUnit列表
└─────────────┘
    │
    ▼
┌─────────────┐
│ RuleHandler │ ──→ 为每个ReviewUnit计算置信度和建议
└─────────────┘
    │
    ▼
┌─────────────┐
│ review_index│ ──→ 结构化的审查索引（JSON）
└─────────────┘
    │
    ├──────────────────────┐
    ▼                      ▼
┌─────────────┐      ┌─────────────┐
│IntentAgent  │      │PlanningAgent│
│(项目意图)    │ ──→  │(上下文规划)  │
└─────────────┘      └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   Fusion    │ ──→ 融合规则建议与LLM决策
                    └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ContextSched│ ──→ 拉取实际的代码上下文
                    └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ContextBundle│ ──→ 打包好的上下文（diff+函数+文件+调用方）
                    └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │CodeReviewAgt│ ──→ 执行审查，输出报告
                    └─────────────┘
```

## 模块划分

### Agent层 (`Agent/agents/`)

| 模块 | 职责 |
|------|------|
| `intent_agent.py` | 项目意图分析 |
| `planning_agent.py` | 上下文规划 |
| `code_reviewer.py` | 审查执行 |
| `fusion.py` | 规则与LLM决策融合 |
| `context_scheduler.py` | 上下文调度和拉取 |
| `prompts.py` | 各Agent的系统提示词 |

### Core层 (`Agent/core/`)

| 模块 | 职责 |
|------|------|
| `review_kernel.py` | 审查内核，编排各模块 |
| `api/` | API门面层，对外暴露接口 |
| `adapter/` | LLM适配器，统一不同厂商接口 |
| `llm/` | LLM客户端实现 |
| `context/` | 上下文提供器 |
| `state/` | 会话状态管理 |
| `stream/` | 流式处理器 |
| `tools/` | 工具运行时 |
| `logging/` | 日志系统 |
| `services/` | 内部服务（提示词构建、工具策略等） |

### DIFF层 (`Agent/DIFF/`)

| 模块 | 职责 |
|------|------|
| `diff_collector.py` | Diff收集和解析 |
| `review_units.py` | ReviewUnit构建 |
| `git_operations.py` | Git操作封装 |
| `output_formatting.py` | 输出格式化 |
| `rule/` | 规则解析子系统 |
| `issue/` | 冲突追踪和规则分析 |

### Tool层 (`Agent/tool/`)

| 模块 | 职责 |
|------|------|
| `registry.py` | 工具注册中心 |
| 内置工具 | list_project_files, read_file_hunk, search_in_project等 |

## 关键数据结构

### ReviewUnit

变更单元，diff解析后的最小审查粒度：

```python
{
    "unit_id": "unit_abc123",
    "file_path": "src/main.py",
    "language": "python",
    "patch_type": "modify",
    "hunk_range": {"new_start": 10, "new_lines": 15, ...},
    "unified_diff": "@@ -10,5 +10,15 @@\n...",
    "tags": ["function_change", "api_endpoint"],
    "metrics": {"added_lines": 10, "removed_lines": 5},
    "rule_context_level": "function",
    "rule_confidence": 0.85,
    "rule_notes": "py:function:api_endpoint"
}
```

### ContextBundle

打包好的审查上下文：

```python
{
    "unit_id": "unit_abc123",
    "meta": {"file_path": "src/main.py", "tags": [...], "location": "src/main.py:L10-L25"},
    "final_context_level": "function",
    "extra_requests": [{"type": "previous_version"}],
    "diff": "@@ src/main.py:L10-L25 @@\n...",
    "function_context": "def my_function():\n    ...",
    "file_context": None,
    "full_file": None,
    "previous_version": None,
    "callers": []
}
```

### FusedPlan

融合后的上下文计划：

```python
{
    "plan": [
        {
            "unit_id": "unit_abc123",
            "rule_context_level": "function",
            "rule_confidence": 0.85,
            "llm_context_level": "file_context",
            "final_context_level": "file_context",
            "extra_requests": [{"type": "callers", "details": "my_function"}],
            "skip_review": False,
            "reason": "llm_upgrade_context"
        }
    ]
}
```

## 扩展点

### 添加新的LLM厂商

1. 在 `Agent/core/llm/client.py` 中实现 `BaseLLMClient` 子类
2. 在 `Agent/core/api/factory.py` 中注册新厂商
3. 配置环境变量（API Key等）

### 添加新的规则处理器

1. 在 `Agent/DIFF/rule/` 中创建 `rule_lang_xxx.py`
2. 继承 `RuleHandler` 基类，实现 `match` 方法
3. 在 `rule_registry.py` 中注册

### 添加新的工具

1. 在 `Agent/tool/registry.py` 中定义工具函数
2. 使用 `@register_tool` 装饰器注册
3. 配置工具的默认启用状态

## 相关文档

- [系统概述](系统概述.md)：系统定位和创新点
- [审查链路](../技术详解/审查链路.md)：完整的审查流程详解
- [规范化适配层](../技术详解/规范化适配层.md)：LLM适配层的详细说明
- [API调用](../API调用.md)：完整的API文档

***本文档由AI自动生成，可能存在不准确的问题，不过仍然使用`GPT-5.2 X-High Reasoning`进行多次交叉验证***
