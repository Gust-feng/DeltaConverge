# 代码审查内核系统概述

## 系统定位

这是一个基于大语言模型（LLM）的智能代码审查内核，核心目标是解决传统AI代码审查工具面临的两大问题：**上下文不足**和**信息噪音**。

系统不是简单地将代码变更丢给LLM然后等待结果，而是通过多Agent协作、规则驱动的上下文调度，让LLM在"恰到好处"的上下文中进行审查——既不会因为信息太少而漏掉问题，也不会因为信息太多而产生无关建议。

## 核心理念

### 规则+LLM融合

传统方案要么完全依赖规则（静态分析），要么完全依赖LLM（端到端生成）。本系统采用"规则层提供先验知识，LLM层提供智能决策"的融合模式：

- **规则层**：基于文件路径、变更模式、语言特征等静态信息，快速计算每个变更单元的"置信度"和"建议上下文级别"
- **LLM层**：基于规则层的索引，结合项目意图理解，做出最终的上下文调度决策
- **融合层**：将规则建议与LLM决策按置信度加权融合，高置信度时规则优先，低置信度时LLM优先

这种设计让系统既有规则的确定性和效率，又有LLM的灵活性和理解能力。

### 精准上下文调度

系统的核心创新在于"上下文调度"——不是把所有代码都塞给LLM，而是根据变更的特征，精准地选择需要的上下文：

```
变更类型          → 上下文级别
─────────────────────────────────
仅导入语句变更    → diff_only（只看diff）
单函数内部修改    → function（函数级上下文）
跨函数/接口变更   → file_context（文件级上下文）
配置/安全敏感     → full_file（必要时附加历史版本等额外上下文）
```

这种分级策略大幅降低了tokens消耗，同时保证了审查质量。

## 创新点总览

### 1. 多Agent协作架构

系统采用三个专职Agent协作完成审查任务：

| Agent | 职责 | 输入 | 输出 |
|-------|------|------|------|
| IntentAgent | 理解项目整体意图 | 文件树、README、提交历史 | 项目概览Markdown |
| PlanningAgent | 规划上下文调度策略 | 规则索引、项目意图 | 上下文计划JSON |
| CodeReviewAgent | 执行实际审查 | 上下文包、工具链 | 审查报告 |

这种分工让每个Agent专注于自己擅长的任务，避免了单一Agent处理复杂任务时的"注意力分散"问题。

### 2. 置信度驱动的融合策略

规则层为每个变更单元计算一个0-1的置信度值，这个值决定了融合时的权重：

- **高置信度（≥0.8）**：规则建议为权威来源，LLM只能"升级"上下文级别，不能降级
- **中等置信度（0.3-0.8）**：规则与LLM建议按优先级融合
- **低置信度（<0.3）**：优先采用LLM的决策

这种机制让系统在"确定的事情上快速决策，不确定的事情上借助LLM"。

### 3. 自我学习机制

系统会追踪规则层与LLM决策之间的"冲突"，并从中学习：

- 当规则高置信度但LLM要求更多上下文时，说明规则可能低估了复杂度
- 当规则低置信度但LLM多次给出一致决策时，可以提取新规则

这些冲突被记录、分析，满足条件的模式会被自动提升为新规则，形成"使用越多越准确"的正向循环。

### 4. JSON+Markdown混合输入格式

经过[大量调研](..\存档\上下文的权衡\1_DIFF格式.md)，系统采用JSON+Markdown混合格式作为LLM输入：

- **JSON**：用于结构化元数据（文件路径、行号、标签、置信度等），便于程序处理和LLM理解
- **Markdown**：用于代码片段和diff展示，利用LLM对Markdown格式的熟悉度

这种设计比纯JSON节省tokens，比纯Markdown更易于程序化处理。

## 与传统工具对比

| 特性 | 传统静态分析 | 简单LLM审查 | 本系统 |
|------|-------------|-------------|--------|
| 上下文理解 | 无 | 有限（受tokens限制） | 精准调度 |
| 规则可配置 | 是 | 否 | 是（规则+学习） |
| 误报率 | 高 | 中 | 低（融合策略） |
| 适应性 | 低 | 高 | 高（自我学习） |
| tokens效率 | N/A | 低 | 高（分级上下文） |

## 技术栈

- **语言**：Python 3.10+
- **LLM支持**：GLM、百炼、ModelScope、Moonshot、OpenRouter、SiliconFlow、DeepSeek、MiniMax
- **静态分析**：集成pylint、flake8、eslint等主流工具
- **版本控制**：Git（支持 working/staged/pr/auto 四种模式）

## 相关文档

- [架构设计](架构设计.md)：详细的系统架构和模块划分
- [审查链路](../技术详解/审查链路.md)：完整的审查流程详解
- [规则解析系统](../技术详解/规则解析系统.md)：规则层的设计和实现
- [自我学习机制](../技术详解/自我学习机制.md)：冲突追踪和规则增长

***本文档由AI自动生成，可能存在不准确的问题，不过仍然使用`GPT-5.2 X-High Reasoning`进行多次交叉验证***
