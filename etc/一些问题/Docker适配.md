# Docker 适配指南

## 问题背景

在 Docker 容器中使用本系统对**大型项目**进行代码审查时，可能会遇到明显的加载延迟。这是由于 Docker 的文件系统挂载机制导致的 **I/O 性能瓶颈**。

> [!NOTE]
> 此问题主要影响大型项目（通常指代码行数超过 10 万行或文件数量超过 1000 个的项目）。对于中小型项目，Docker 环境下的性能表现通常是可以接受的。

## 问题原因

Docker 使用 **bind mount** 挂载宿主机目录时，会引入额外的文件系统层：

1. **跨文件系统调用**：每次文件访问都需要经过 Docker 的虚拟文件系统层
2. **缓存失效**：频繁的文件扫描可能导致缓存命中率下降
3. **元数据操作开销**：大量文件的 `stat` 操作在挂载卷上尤其缓慢

## 缓解措施

### 1. 使用 Volume 而非 Bind Mount

```bash
# 创建命名卷
docker volume create code-review-data

# 使用卷挂载（性能更优）
docker run -v code-review-data:/app/data ...
```

### 2. 使用 delegated 挂载模式（macOS）

```bash
docker run -v /path/to/code:/app/code:delegated ...
```

> [!TIP]
> `delegated` 模式允许容器内的写入延迟同步到宿主机，可以显著提升写入性能。

### 3. 启用增量扫描

在配置中启用增量扫描模式，避免每次都进行全量文件扫描：

```yaml
scanner:
  mode: incremental
  cache_enabled: true
```

### 4. 排除不必要的目录

配置 `.gitignore` 或在系统配置中指定排除规则，跳过 `node_modules`、`vendor`、`.git` 等大型目录。

### 5. 本地部署（推荐）

> [!IMPORTANT]
> 对于大型项目，**强烈建议**直接在宿主机本地运行本系统，以获得最佳性能体验。

## 性能对比参考

| 部署方式 | 小型项目 (< 1万行) | 中型项目 (1-10万行) | 大型项目 (> 10万行) |
|---------|-------------------|--------------------|--------------------|
| 本地部署 | ⚡ 极快 | ⚡ 快速 | ✅ 正常 |
| Docker (Volume) | ⚡ 快速 | ✅ 正常 | ⚠️ 较慢 |
| Docker (Bind Mount) | ✅ 正常 | ⚠️ 较慢 | ❌ 明显延迟 |

## 总结

Docker 适配的 I/O 性能问题是容器化技术的固有特性，而非本系统的设计缺陷。通过合理选择挂载方式、启用缓存和增量扫描，可以有效缓解这一问题。对于追求极致性能的场景，建议采用本地部署方案。